<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Calculator - Pediatric | ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
  #vitInfant:checked + label { background-color: #2563eb !important; color: white; border-color: #1e40af; }
#vitAdult:checked + label { background-color: #db2777 !important; color: white; border-color: #9d174d; }
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Inter', sans-serif;
    }
    
    .gradient-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab5 100%);
    }
    
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .input-focus:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: #3b82f6;
    }
    
    .section-title {
      position: relative;
      padding-left: 12px;
    }
    
    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #3b82f6, #1d4ed8);
      border-radius: 2px;
    }
    
    .result-highlight {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-left: 4px solid #0ea5e9;
    }
    
    .warning-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
    }
    
    .success-box {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-left: 4px solid #10b981;
    }
    
    .table-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    }
    
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    .radio-custom:checked + label {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .checkbox-custom:checked + label {
      background-color: #10b981;
      color: white;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    .print-section {
      display: none;
    }
    
    @media print {
      .no-print {
        display: none !important;
      }
      .print-section {
        display: block !important;
      }
      body {
        font-size: 12pt;
      }
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .tab-button.inactive {
      background-color: white;
      color: #6b7280;
      border-color: #e5e7eb;
    }
    }
    html {
  height: auto;
}

body {
  min-height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Dropdown ‡∏Ç‡∏≠‡∏á Ward ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ */
#wardDropdown {
  z-index: 9999 !important;
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ */
#compositionTable td {
  padding-top: 12px;
  padding-bottom: 12px;
  font-size: 15px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ */
}

/* ‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
#compositionTable .bg-gray-800 span {
  font-size: 18px; 
}

/* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡∏Ç‡∏≠‡∏á Electrolyte */
.electrolyte-vol-input {
  font-size: 16px !important;
  font-weight: 700 !important;
  width: 70px !important; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡∏¢‡∏î */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat */
#prepDetails p {
  font-size: 16px;
  line-height: 1.6;
}
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">
    <!-- Header -->
   <header class="gradient-header text-white py-4 px-6 sticky top-0 z-50 shadow-lg no-print">
      <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
            </svg>
          </div>
          <div>
            <h1 id="appTitle" class="text-xl font-bold tracking-tight">TPN Calculator - Pediatric</h1>
            <p id="hospitalName" class="text-blue-100 text-sm">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</p>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
          <a href="dashboard.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all text-sm font-bold shadow-lg flex items-center gap-2">
            üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </a>
          <button onclick="resetForm()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm border border-white/20">
            üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
<main id="mainContent" class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
      
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in relative z-30">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order TPN <span class="text-red-600 font-bold ml-1">*‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á*</span>
  </label>
  <div class="flex gap-1">
    <input type="date" id="orderDate" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all bg-white">
    <button type="button" onclick="setToday()" class="px-3 py-2.5 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl hover:bg-blue-600 hover:text-white transition-all text-xs font-bold whitespace-nowrap shadow-sm">
      ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üìÖ
    </button>
  </div>
</div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">HN (‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ)</label>
            <input type="text" id="hn" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå HN" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" autofocus>
          </div>
          <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
  <input type="text" id="patientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
  <p id="searchStatus" class="text-[11px] mt-1 font-medium"></p> 
</div>
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ward</label>
            <div class="relative">
              <input type="text" id="wardInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" onfocus="showWardList()" oninput="filterWardList()" autocomplete="off">
              <input type="hidden" id="ward"> 
              <div id="wardDropdown" class="hidden absolute left-0 right-0 z-[100] mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl max-h-60 overflow-y-auto">
                <div id="wardOptions" class="py-1"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in relative z-10">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4"> üíâ Route ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ TPN</h2>
        <div class="flex flex-wrap gap-3">
          <input type="radio" name="route" id="central" value="central" class="hidden radio-custom" checked>
          <label for="central" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2">
            <span class="text-xl">ü©∏</span> Central Line
          </label>
          <input type="radio" name="route" id="peripheral" value="peripheral" class="hidden radio-custom">
          <label for="peripheral" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2">
            <span class="text-xl">ü§öüèª</span> Peripheral Line
          </label>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (BW)</label>
            <div class="relative">
              <input type="number" id="bw" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">kg</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Total TPN Volume (‡∏£‡∏ß‡∏° Fat) ‡∏ó‡∏µ‡πà‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
            <div class="relative">
              <input type="number" id="totalVolume" step="1" min="0" placeholder="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>
        </div>
      </section>

    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
    <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üßà ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat + Vitalipid¬Æ </h2>
    
    <div class="flex flex-wrap gap-2 mb-4 p-3 bg-amber-50/50 rounded-xl border border-amber-100">
        <span class="text-sm font-bold text-amber-800 w-full mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÑ‡∏Ç‡∏°‡∏±‡∏ô:</span>
        <input type="radio" name="fatProduct" id="smof" value="smof" class="hidden radio-custom" checked onchange="calculateAll()">
        <label for="smof" class="px-4 py-2 bg-white border border-gray-300 rounded-lg cursor-pointer text-xs font-medium transition-all hover:bg-amber-50">20% SMOF Lipid</label>
        <input type="radio" name="fatProduct" id="intralipid" value="intralipid" class="hidden radio-custom" onchange="calculateAll()">
        <label for="intralipid" class="px-4 py-2 bg-white border border-gray-300 rounded-lg cursor-pointer text-xs font-medium transition-all hover:bg-amber-50">20% Intralipid</label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fat ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ (Fat requirement) </label>
            <div class="relative">
                <input type="number" id="fatTarget" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-24" inputmode="decimal" oninput="calculateFatLogic('fat_dose')">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
            <div class="mt-2 flex items-center gap-2 p-2 bg-amber-50 rounded-lg border border-amber-100">
                <input type="checkbox" id="deductVitalipid" class="w-4 h-4 rounded text-blue-600 cursor-pointer" onchange="calculateFatLogic('fat_dose')">
                <label for="deductVitalipid" class="text-[11px] text-gray-700 cursor-pointer font-medium">‡∏´‡∏±‡∏Å Fat ‡∏à‡∏≤‡∏Å Vitalipid¬Æ</label>
                <input type="number" id="vitalipidFatValue" step="0.01" value="0.4" class="w-14 px-1 py-0.5 border border-gray-300 rounded text-xs text-center font-bold text-blue-700" oninput="calculateFatLogic('fat_dose')">
                <span class="text-[10px] text-gray-500">g/kg</span>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Net Fat ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
            <div class="relative">
                <input type="number" id="netFat" step="0.1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-100 pr-24 font-semibold text-gray-600" readonly inputmode="decimal">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fat Volume <span class="text-blue-600 italic">*‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©*</span></label>
            <div class="relative">
                <input type="number" id="fatVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl bg-blue-50 font-bold text-blue-700 pr-12" inputmode="decimal" oninput="calculateFatLogic('fat_vol')">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
        </div>
        <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">üîã Vitalipid¬Æ Product</label>
    <div class="flex gap-2 mb-2">
        <input type="radio" name="vitProduct" id="vitInfant" value="Infant" class="hidden radio-custom" checked onchange="calculateAll()">
        <label for="vitInfant" class="flex-1 px-2 py-2 bg-white border border-blue-300 rounded-lg cursor-pointer text-[11px] font-bold text-center transition-all hover:bg-blue-50 checked:bg-blue-600">üçº Vitalipid N-Infant</label>
        
        <input type="radio" name="vitProduct" id="vitAdult" value="Adult" class="hidden radio-custom" onchange="calculateAll()">
        <label for="vitAdult" class="flex-1 px-2 py-2 bg-white border border-pink-300 rounded-lg cursor-pointer text-[11px] font-bold text-center transition-all hover:bg-pink-50 checked:bg-pink-600">üë®üèª Vitalipid N-Adult</label>
    </div>
    <div class="relative">
        <input type="number" id="vitalipid" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 font-semibold text-blue-700" inputmode="decimal" oninput="handleVitalipidManualChange()">
        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
    </div>
    <p id="vitalipidMaxWarning" class="hidden text-[10px] text-red-600 mt-1 font-bold">‚ö†Ô∏è Max = 10 ml</p>
</div>
</section>

     <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíâ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≤‡∏£‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</label>
            <div class="space-y-2">
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="flush" value="none" checked onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÑ‡∏°‡πà‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span>
              </label>
              <div class="flex items-center gap-2">
  <input type="radio" name="flush" value="custom" onchange="calculateFatAdmin()">
  <span class="text-sm font-medium text-blue-600">+</span>
  <input type="number" id="flushVolume" 
         placeholder="0" 
         class="w-20 px-3 py-1.5 border-2 border-blue-200 rounded-lg text-sm font-bold text-blue-700 bg-blue-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all shadow-sm" 
         inputmode="decimal" 
         oninput="isFlushManual = true; calculateFatAdmin()">
  <span class="text-xs font-semibold text-blue-600 italic">ml ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span>
</div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"> ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ Fat+‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢+ Vitalipid¬Æ</label>
            <div class="relative">
              <input type="number" id="totalFatPlusVitalipid" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-blue-50 font-bold text-blue-700" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml</span>
            </div>
            <p class="text-[10px] text-gray-500 mt-1">(Fat + Flush + Vit)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡πà‡∏á‡πÉ‡∏ô ward NICU, 2‡∏Ñ) </label>
            <div class="space-y-2">
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="prepSplit" value="none" checked onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á</span>
              </label>
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="prepSplit" value="split" onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° ‡πÄ‡∏õ‡πá‡∏ô 2 syr/‡∏Ç‡∏ß‡∏î</span>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 whitespace-nowrap">
  Drip Rate <span id="autoFatRateLabel" class="text-blue-600 font-bold ml-1">(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ = 0.0 ml/hr)</span>
</label>
<div class="relative">
  <input type="number" id="manualFatDripRate" step="0.1" placeholder="0.0" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-blue-700" oninput="calculateFatAdmin()">
  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml/hr</span>
</div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíß PN Volume & Rate</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PN Volume (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</label>
            <div class="relative">
              <input type="number" id="pnVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 bg-gray-50 font-semibold text-gray-600" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ö‡∏ß‡∏Å‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</label>
            <div class="relative">
              <input type="number" id="pnFlushVolume" value="30" step="1" min="0" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl input-focus transition-all pr-12 font-bold text-blue-700" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PN Volume ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</label>
            <div class="relative">
              <input type="number" id="pnPrepVolume" step="0.1" class="w-full px-4 py-2.5 border border-green-300 rounded-xl bg-green-50 pr-12 font-bold text-green-700" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Rate TPN (PN √∑ 24)</label>
            <div class="relative">
              <input type="number" id="rateTPN" step="0.01" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl input-focus transition-all pr-16 font-bold text-blue-700" oninput="handleRateManualChange()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml/hr</span>
            </div>
          </div>
        </div>
      </section>

   <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
  <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">Macronutrient</h2>
  
  <div class="p-4 bg-purple-50 rounded-xl border border-purple-100 mb-6">
    <div class="flex flex-wrap gap-2 mb-3">
      <span class="text-sm font-bold text-purple-800 w-full mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Protein Product:</span>
      <input type="radio" name="proteinProduct" id="aminoven" value="aminoven" class="hidden radio-custom" checked onchange="calculateProteinLogic('prot_dose')">
      <label for="aminoven" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg cursor-pointer text-xs font-medium transition-all">10% Aminoven Infant</label>
      
      <input type="radio" name="proteinProduct" id="amiparen" value="amiparen" class="hidden radio-custom" onchange="calculateProteinLogic('prot_dose')">
      <label for="amiparen" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg cursor-pointer text-xs font-medium transition-all">10% Amiparen</label>
      
      <input type="radio" name="proteinProduct" id="aminoplasmal" value="aminoplasmal" class="hidden radio-custom" onchange="calculateProteinLogic('prot_dose')">
      <label for="aminoplasmal" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg cursor-pointer text-xs font-medium transition-all">15% Aminoplasmal</label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">Dose (g/kg/day)</label>
        <input type="number" id="proteinTarget" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-purple-200 rounded-lg font-bold text-purple-700" oninput="calculateProteinLogic('prot_dose')">
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">Total (g/day)</label>
        <input type="number" id="proteinGrams" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-purple-200 rounded-lg font-bold text-purple-700" oninput="calculateProteinLogic('prot_grams')">
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">Protein Vol (ml)</label>
        <input type="number" id="proteinVolInput" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-blue-300 rounded-lg font-bold text-blue-700 bg-blue-50" oninput="calculateProteinLogic('prot_vol')">
      </div>
    </div>
  </div>

  <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 mb-4">
    <span class="text-sm font-bold text-blue-800 w-full block mb-3">Dextrose (‡πÉ‡∏ä‡πâ 50% Dextrose ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°):</span>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">% Dextrose ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏ñ‡∏∏‡∏á</label>
        <div class="relative">
          <input type="number" id="dextrosePercent" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-blue-200 rounded-lg font-bold text-blue-700" oninput="calculateDextroseLogic('dex_percent')">
          <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400">%</span>
        </div>
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">Total (g/day)</label>
        <input type="number" id="dextroseGrams" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-blue-200 rounded-lg font-bold text-blue-700" oninput="calculateDextroseLogic('dex_grams')">
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">50% Dex Vol (ml)</label>
        <input type="number" id="dextroseVolInput" step="any" inputmode="decimal" class="w-full px-4 py-2 border border-blue-300 rounded-lg font-bold text-blue-700 bg-blue-50" oninput="calculateDextroseLogic('dex_vol')">
      </div>
    </div>

    <div id="girContainer" class="p-3 bg-white rounded-lg border border-blue-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xl">üìä</span>
          <span class="text-sm font-medium text-gray-600">GIR:</span>
          <span id="girValue" class="text-xl font-bold text-blue-700">0.00</span>
          <span class="text-xs text-gray-500">mg/kg/min</span>
        </div>
        <div id="girWarning" class="hidden text-xs text-red-600 font-bold animate-pulse">‚ö†Ô∏è GIR > 12</div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Fat (Net Fat)</label>
      <div class="relative">
        <input type="number" id="fatDisplay" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-100 pr-24 font-semibold text-gray-600" readonly>
        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
      </div>
    </div>
  </div>
</section>

      <!-- Electrolytes Section -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
  <h2 class="section-title text-xl font-bold text-gray-800 mb-6">‚öóÔ∏è Electrolytes</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
    
   <div class="space-y-3">
  <div class="flex flex-col space-y-2">
    <label class="block text-base font-bold text-gray-800 text-center">Phosphate Source</label>
    <div class="grid grid-cols-2 gap-2">
      <div class="relative">
        <input type="radio" id="phosGlyco" name="phosSource" value="Glycophos" checked class="hidden peer" onchange="calculateAll()">
        <label for="phosGlyco" class="flex items-center justify-center px-2 py-2 border-2 rounded-xl cursor-pointer text-xs font-bold transition-all peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 border-gray-200 text-gray-600">
          Glycophos
        </label>
      </div>
      <div class="relative">
        <input type="radio" id="phosK2HPO4" name="phosSource" value="K2HPO4" class="hidden peer" onchange="calculateAll()">
        <label for="phosK2HPO4" class="flex items-center justify-center px-2 py-2 border-2 rounded-xl cursor-pointer text-xs font-bold transition-all peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600 border-gray-200 text-gray-600">
          K2HPO4
        </label>
      </div>
    </div>
  </div>

  <p class="text-xs text-gray-500 italic">Dose: 0.5-1 mmol/kg/day</p>
  <input type="number" id="phosphorus" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all font-semibold text-lg" inputmode="decimal" oninput="calculateAll()">
  
  <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100 space-y-2">
    <div class="flex justify-between items-center">
      <span class="text-sm font-bold text-blue-800">Vol:</span>
      <div class="flex items-baseline">
        <input type="number" id="phosvol" step="0.1" class="w-20 bg-transparent text-right text-xl font-black text-blue-700 border-b-2 border-blue-300 focus:outline-none focus:border-blue-600" oninput="isPhosVolManual = true; calculateAll()">
        <span class="ml-1 text-sm font-bold text-blue-700">ml</span>
      </div>
    </div>

    <div id="naFromP_Row" class="flex justify-between items-center pt-1 border-t border-blue-200">
      <span class="text-[11px] font-medium text-gray-600">Na from P:</span>
      <div class="flex items-baseline">
        <input type="number" id="phoNa" step="0.1" class="w-14 bg-transparent text-right text-xs font-bold text-gray-700 border-b border-gray-300 focus:outline-none" oninput="isPhosNaManual = true; calculateAll()">
        <span class="ml-1 text-[10px] text-gray-500 font-bold">mEq</span>
      </div>
    </div>

    <div id="kFromP_Row" class="flex justify-between items-center pt-1 border-t border-purple-200 hidden">
      <span class="text-[11px] font-medium text-purple-600 font-bold">K from Phos:</span>
      <div class="flex items-baseline">
        <span id="kFromP_Val" class="text-xs font-bold text-purple-700">0.00</span>
        <span class="ml-1 text-[10px] text-purple-500 font-bold">mEq</span>
      </div>
    </div>
  </div>
</div>

    <div class="space-y-3">
      <label class="block text-base font-bold text-gray-800">Na (3% NaCl)</label>
      <p class="text-xs text-gray-500 italic">2-4 mEq/kg/day</p>
      <input type="number" id="sodium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all font-semibold text-lg" inputmode="decimal" oninput="calculateAll()">
      
      <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <div class="flex justify-between items-center">
          <span class="text-sm font-bold text-blue-800">Vol:</span>
          <div class="flex items-baseline">
            <input type="number" id="navol" step="0.1" class="w-20 bg-transparent text-right text-xl font-black text-blue-700 border-b-2 border-blue-300 focus:outline-none focus:border-blue-600" oninput="isNaVolManual = true; calculateAll()">
            <span class="ml-1 text-sm font-bold text-blue-700">ml</span>
          </div>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <label class="block text-base font-bold text-gray-800">K (KCl)</label>
      <p class="text-xs text-gray-500 italic">2-4 mEq/kg/day</p>
      <input type="number" id="potassium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all font-semibold text-lg" inputmode="decimal" oninput="calculateAll()">
      
      <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <div class="flex justify-between items-center">
          <span class="text-sm font-bold text-blue-800">Vol:</span>
          <div class="flex items-baseline">
            <input type="number" id="kvol" step="0.1" class="w-20 bg-transparent text-right text-xl font-black text-blue-700 border-b-2 border-blue-300 focus:outline-none focus:border-blue-600" oninput="isKVolManual = true; calculateAll()">
            <span class="ml-1 text-sm font-bold text-blue-700">ml</span>
          </div>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <label class="block text-base font-bold text-gray-800">Mg (50% MgSO‚ÇÑ)</label>
      <p class="text-xs text-gray-500 italic">0.2-0.3 mmol/kg/day</p>
      <input type="number" id="magnesium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all font-semibold text-lg" inputmode="decimal" oninput="calculateAll()">
      
      <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <div class="flex justify-between items-center">
          <span class="text-sm font-bold text-blue-800">Vol:</span>
          <div class="flex items-baseline">
            <input type="number" id="mgvol" step="0.01" class="w-20 bg-transparent text-right text-xl font-black text-blue-700 border-b-2 border-blue-300 focus:outline-none focus:border-blue-600" oninput="isMgVolManual = true; calculateAll()">
            <span class="ml-1 text-sm font-bold text-blue-700">ml</span>
          </div>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <label class="block text-base font-bold text-gray-800 font-sans">Ca (10% Ca Glu)</label>
      <p class="text-xs text-gray-500 italic">4-6 ml/kg/day</p>
      <input type="number" id="calcium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all font-semibold text-lg" inputmode="decimal" oninput="calculateAll()">
      
      <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <div class="flex justify-between items-center">
          <span class="text-sm font-bold text-blue-800">Vol:</span>
          <div class="flex items-baseline">
            <input type="number" id="cavol" step="0.1" class="w-20 bg-transparent text-right text-xl font-black text-blue-700 border-b-2 border-blue-300 focus:outline-none focus:border-blue-600" oninput="isCaVolManual = true; calculateAll()">
            <span class="ml-1 text-sm font-bold text-blue-700">ml</span>
          </div>
        </div>
      </div>
      <p id="caMaxWarning" class="hidden text-[10px] text-red-600 mt-1 font-bold animate-pulse">‚ö†Ô∏è Max = 10 ml</p>
    </div>

  </div>
</section>

      <!-- Vitamins & Trace Elements Section -->
     <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
  <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíä Vitamin & Trace Elements</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    
    <div class="p-4 bg-green-50 rounded-xl border border-green-200">
      <h3 class="font-semibold text-green-800 mb-3">üíâ Vitamin</h3>
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
          <div class="relative">
            <input type="radio" id="vitSoluvit" name="vitSource" value="Soluvit" checked class="hidden peer" onchange="calculateAll()">
            <label for="vitSoluvit" class="flex items-center justify-center px-2 py-1.5 border border-gray-300 rounded-lg cursor-pointer text-[11px] font-bold transition-all peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white text-gray-600">Soluvit</label>
          </div>
          <div class="relative">
            <input type="radio" id="vitCernevit" name="vitSource" value="Cernevit" class="hidden peer" onchange="calculateAll()">
            <label for="vitCernevit" class="flex items-center justify-center px-2 py-1.5 border border-gray-300 rounded-lg cursor-pointer text-[11px] font-bold transition-all peer-checked:bg-pink-600 peer-checked:text-white peer-checked:border-pink-600 bg-white text-gray-600">Cernevit</label>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-2">
            <input type="number" id="vitvol" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all font-bold text-green-700" inputmode="decimal" oninput="isVitVolManual = true; calculateAll()">
            <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
          </div>
          <p id="vitHint" class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 10 ml)</p>
          <p id="vitWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î!</p>
        </div>
      </div>
    </div>

    <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200">
      <h3 class="font-semibold text-cyan-800 mb-3">üî¨ Trace Elements</h3>
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
          <div class="relative">
            <input type="radio" id="tracePeditrace" name="traceSource" value="Peditrace" checked class="hidden peer" onchange="calculateAll()">
            <label for="tracePeditrace" class="flex items-center justify-center px-2 py-1.5 border border-gray-300 rounded-lg cursor-pointer text-[11px] font-bold transition-all peer-checked:bg-cyan-600 peer-checked:text-white peer-checked:border-cyan-600 bg-white text-gray-600">Peditrace</label>
          </div>
          <div class="relative">
            <input type="radio" id="traceAddamel" name="traceSource" value="Addamel" class="hidden peer" onchange="calculateAll()">
            <label for="traceAddamel" class="flex items-center justify-center px-2 py-1.5 border border-gray-300 rounded-lg cursor-pointer text-[11px] font-bold transition-all peer-checked:bg-teal-600 peer-checked:text-white peer-checked:border-teal-600 bg-white text-gray-600">Addamel-N</label>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-2">
            <input type="number" id="tracevol" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all font-bold text-cyan-700" inputmode="decimal" oninput="isTraceVolManual = true; calculateAll()">
            <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
          </div>
          <p id="traceHint" class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 15 ml)</p>
          <p id="traceWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î!</p>
        </div>
      </div>
    </div>

  </div>
</section>

   <!-- Additive Section -->
<section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
  <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üß™ Additive</h2>
  <div class="space-y-6">
   <!-- ‚úÖ ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏¢‡∏Å section ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- ZINC: ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ -->
    <div class="p-4 bg-orange-50 rounded-xl border border-orange-200">
        <h3 class="font-bold text-orange-800 mb-3">üë∂üèª Zinc Sulfate</h3>
        <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-orange-50 border border-transparent has-[:checked]:border-orange-400 transition-all">
                <input type="radio" name="zinc" value="yes" onchange="calculateAll()">
                <div>
                    <span class="font-medium text-gray-800">Add Zinc Sulfate</span>
                    <p class="text-xs text-gray-500">500 mcg/ml = 0.3 ml √ó BW</p>
                </div>
            </label>
            
            <!-- Zinc Volume Input: ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Yes -->
            <div id="zincVolumeDiv" class="hidden px-3 pb-2">
                <div class="flex items-center gap-2 p-2 bg-orange-50 rounded-lg border border-orange-200">
                    <span class="text-sm text-orange-700 font-medium">Volume:</span>
                    <input type="number" id="zincvol" step="0.01" min="0"
                           class="w-24 px-2 py-1.5 border-2 border-orange-300 rounded-lg text-sm font-bold text-orange-700 focus:outline-none focus:border-orange-500"
                           inputmode="decimal" oninput="calculateAll()">
                    <span class="text-sm font-bold text-orange-600">ml</span>
                </div>
            </div>

            <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 border border-transparent has-[:checked]:border-gray-400 transition-all">
                <input type="radio" name="zinc" value="no" checked onchange="calculateAll()">
                <span class="font-medium text-gray-600 italic">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° Zinc</span>
            </label>
        </div>
    </div>

    <!-- HEPARIN: ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Zinc ‡πÄ‡∏•‡∏¢ -->
    <div class="p-4 bg-pink-50 rounded-xl border border-pink-200">
        <h3 class="font-semibold text-pink-800 mb-3">üíâ Heparin</h3>
        <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-pink-50 border border-transparent has-[:checked]:border-pink-400 transition-all">
                <input type="radio" name="heparin" value="yes" onchange="calculateAll()">
                <div>
                    <span class="font-medium text-gray-800">‡πÄ‡∏ï‡∏¥‡∏° Heparin</span>
                    <p class="text-xs text-gray-500">1 unit/ml √ó PN volume</p>
                </div>
            </label>

            <!-- Heparin Display: ‡πÇ‡∏ä‡∏ß‡πå Units + Volume -->
            <div id="heparinValueDiv" class="hidden px-3 pb-2">
                <div class="p-2 bg-pink-50 rounded-lg border border-pink-200 space-y-1">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Units:</span>
                        <span id="heparinUnits" class="text-sm font-bold text-pink-700">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Volume (√∑500):</span>
                        <span id="heparinVolume" class="text-sm font-bold text-pink-700">-</span>
                    </div>
                </div>
            </div>

            <label class="flex items-center gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 border border-transparent has-[:checked]:border-gray-400 transition-all">
                <input type="radio" name="heparin" value="no" checked onchange="calculateAll()">
                <span class="font-medium text-gray-600 italic">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° Heparin</span>
            </label>
        </div>
    </div>
</div>


    <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
      <h3 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
        <span>‚ûï</span> Add ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</label>
          <input type="text" id="additiveOtherName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Taurine, L-Carnitine" 
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all shadow-sm" 
                 oninput="calculateAll()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£</label>
          <div class="relative">
            <input type="number" id="additiveOtherVolume" step="0.1" min="0" placeholder="0" 
                   class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 shadow-sm" 
                   inputmode="decimal" oninput="calculateAll()">
            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

      <!-- Composition Table -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
  <h2 class="section-title text-xl font-bold text-gray-800 mb-6">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order TPN</h2>
  <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
    <table class="w-full">
      <thead>
        <tr class="table-header text-white text-base bg-gray-800">
          <th class="px-4 py-4 text-left font-bold rounded-tl-xl">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</th>
          <th class="px-4 py-4 text-right font-bold">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</th>
          <th class="px-4 py-4 text-right font-bold text-yellow-300 bg-black/10">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (ml)</th>
          <th class="px-4 py-4 text-right font-bold">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</th>
          <th class="px-4 py-4 text-right font-bold rounded-tr-xl">mOsmol/L</th>
        </tr>
      </thead>
      <tbody id="compositionTable" class="text-sm md:text-base">
        <tr class="border-b-2 border-gray-100 font-bold bg-gray-50 text-gray-800">
          <td colspan="5" class="px-4 py-3 text-lg">Macronutrients</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td id="row-protein-name" class="px-4 py-3 pl-8 text-purple-700 font-bold">Protein Product</td>
          <td id="proteinVol" class="px-4 py-3 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-proteinVol" class="px-4 py-3 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-xl">0.0</td>
          <td id="proteinCal" class="px-4 py-3 text-right font-mono">0.0</td>
          <td id="proteinOsmol" class="px-4 py-3 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="px-4 py-3 pl-8 text-blue-700 font-bold">50% Dextrose</td>
          <td id="dextroseVol" class="px-4 py-3 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-dextroseVol" class="px-4 py-3 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-xl">0.0</td>
          <td id="dextroseCal" class="px-4 py-3 text-right font-mono">0.0</td>
          <td id="dextroseOsmol" class="px-4 py-3 text-right font-mono">0</td>
        </tr>

        <tr class="border-b-2 border-gray-100 font-bold bg-red-50/50 text-red-800">
          <td colspan="5" class="px-4 py-3 text-lg">üßÇ Electrolytes (ml)</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td id="row-phos-name" class="px-4 py-2 pl-8 font-medium">- Phosphorus Source</td>
          <td id="row-phos-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-phos-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td id="row-phos-osmol" class="px-4 py-2 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- 3% NaCl (Na)</td>
          <td id="row-na-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-na-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td id="row-na-osmol" class="px-4 py-2 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- KCl (K)</td>
          <td id="row-k-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-k-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td id="row-k-osmol" class="px-4 py-2 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- 50% MgSO4 (Mg)</td>
          <td id="row-mg-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-mg-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td id="row-mg-osmol" class="px-4 py-2 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- 10% Ca Gluconate (Ca)</td>
          <td id="row-ca-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-ca-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td id="row-ca-osmol" class="px-4 py-2 text-right font-mono">0</td>
        </tr>

        <tr class="border-b-2 border-gray-100 font-bold bg-orange-50/50 text-orange-800">
          <td colspan="5" class="px-4 py-3 text-lg">üß™ Vitamins & Additives (ml)</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td id="row-soluvit-name" class="px-4 py-2 pl-8 font-medium">- Soluvit N</td>
          <td id="row-soluvit-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-soluvit-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td id="row-peditrace-name" class="px-4 py-2 pl-8 font-medium">- Peditrace</td>
          <td id="row-peditrace-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-peditrace-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- Zinc Sulfate</td>
          <td id="row-zinc-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-zinc-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td class="px-4 py-2 pl-8 font-medium">- Heparin</td>
          <td id="row-heparin-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-heparin-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>
        <tr class="border-b border-gray-100 text-sm">
          <td id="row-other-name" class="px-4 py-2 pl-8 font-medium">- Other Additive</td>
          <td id="row-other-vol" class="px-4 py-2 text-right font-mono font-bold text-gray-600">0.0</td>
          <td id="prep-other-vol" class="px-4 py-2 text-right font-mono font-black text-blue-700 bg-blue-100/50 text-lg">0.0</td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>

        <tr class="border-b-2 border-gray-100 bg-blue-50/50">
          <td class="px-4 py-4 font-bold text-blue-700 text-lg">üíß Sterile Water</td>
          <td class="px-4 py-4 text-right">
              <input type="number" id="waterVolInput" step="0.1" class="w-24 px-1 border-b-2 border-blue-300 bg-transparent text-right font-mono font-bold text-blue-800 focus:outline-none" oninput="isWaterManual = true; calculateAll()">
          </td>
          <td class="px-4 py-4 text-right bg-blue-100/50">
              <input type="number" id="prep-waterVolInput" step="0.1" class="w-24 px-1 border-b-2 border-blue-400 bg-transparent text-right font-mono font-black text-blue-700 text-xl focus:outline-none" oninput="isPrepWaterManual = true; calculateAll()">
          </td>
          <td class="text-right">-</td>
          <td class="text-right">-</td>
        </tr>

        <tr class="bg-gray-800 text-white font-bold">
          <td class="px-4 py-5 text-xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          <td class="px-4 py-5 text-right font-mono text-yellow-400 text-xl">
            <span id="totalPNVol_Summary">0.0</span> <span class="text-xs ml-1">ml</span>
          </td>
          <td class="px-4 py-5 text-right font-mono text-cyan-300 bg-gray-700 text-2xl">
            <span id="totalPrepVolDisplay">0.0</span> <span class="text-xs ml-1">ml</span>
          </td>
          <td class="px-4 py-5 text-right font-mono text-xl">
            <span id="totalPNCal">0.0</span> <span class="text-xs ml-1 text-gray-400">kcal</span>
          </td>
          <td class="px-4 py-5 text-right font-mono text-xl">
            <span id="totalOsmol">0</span> <span class="text-xs ml-1 text-gray-400">mOsmol</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
          </table>
        </div>
        <div id="prepSummary" class="mt-6 p-6 success-box rounded-xl border-2 border-green-200">
  <h4 class="font-bold text-green-800 mb-3 text-lg flex items-center gap-2">
    <span>üßà</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat
  </h4>
  
  <div id="prepDetails" class="text-green-700 space-y-2 text-base">
     </div>
</div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-green-50 rounded-xl border border-green-200">
            <div class="text-sm text-green-600 mb-1">Total Calories</div>
            <div class="flex items-baseline gap-2">
              <span id="totalCalDisplay" class="text-2xl font-bold text-green-700">0.0</span>
              <span class="text-green-600">kcal/day</span>
            </div>
          </div>
          <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
            <div class="text-sm text-blue-600 mb-1">Calories per kg</div>
            <div class="flex items-baseline gap-2">
              <span id="calPerKg" class="text-2xl font-bold text-blue-700">0.0</span>
              <span class="text-blue-600">kcal/kg/day</span>
            </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
            <div class="text-sm text-purple-600 mb-1">Final Osmolarity</div>
            <div class="flex items-baseline gap-2">
              <span id="finalOsmol" class="text-2xl font-bold text-purple-700">0</span>
              <span class="text-purple-600">mOsmol/L</span>
            </div>
          </div>
        </div>
        <div id="osmolWarning" class="hidden mt-4 p-4 warning-box rounded-xl">
          <div class="flex items-center gap-2 text-amber-800">
            <span class="text-xl">‚ö†Ô∏è</span>
            <span class="font-medium">Osmolarity ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Peripheral Line (> 900 mOsmol/L) ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Central Line</span>
          </div>
        </div>
      </section>
  
      <!-- Save Order Button -->
      <div class="flex gap-2 justify-end mt-10 mb-8">
        <button id="saveOrderBtn" onclick="saveOrder()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-all flex items-center gap-2">
          <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order
        </button>
      </div>
    </main>
        </section>
    
      <!-- Footer -->
      <footer class="text-center py-6 text-gray-500 text-sm">
        <p>TPN Calculator for Pediatric Patients</p>
      </footer>
    </div>


  <script>
    // ========================================
    // TPN Calculator with Google Apps Script
    // ========================================
    
    // üîß Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbwUXje243vRpBLvqUfP6w-yK_C6AM3Qc2JYtkZGRYntdTdNxqgiYpFwhupZW-VtHRmz/exec';
    
    // Global variables
    let isVitalipidManual = false;
    let isRateManual = false;
  let isPhosNaManual = false, isNaVolManual = false, isKVolManual = false, isMgVolManual = false, isCaVolManual = false;
   let isVitVolManual = false;   // ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≤‡∏à‡∏ä‡∏∑‡πà‡∏≠ isSoluvitManual
let isTraceVolManual = false; // ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≤‡∏à‡∏ä‡∏∑‡πà‡∏≠ isPeditraceManual
    let isFlushManual = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Script
    let isPhosVolManual = false;
    let isWaterManual = false;
    let isPrepWaterManual = false;
    let isPNFlushManual = false;

    // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
const wardList = [
  "2‡∏Ñ", "2‡∏á", "3‡∏Å", "3‡∏Ñ", "3‡∏á", "3‡∏â", "4‡∏Å", "4‡∏Ñ", "5‡∏Ç", "6‡∏Å", "6‡∏Ç", 
  "AE1", "AE2", "AE3", "CCU", "CVT-ICU", "HOME PN", "IMC2‡∏á", "IMC3‡∏Ç", "IMC4‡∏Ç", 
  "MICU 1", "MICU 2", "NICU", "PICU", "PICU ‡∏®‡∏™‡∏Å.", "SCTU", "SICU 1", "SICU 2", 
  "‡∏Å‡∏ß.6/1", "‡∏Å‡∏ß.6/2", "‡∏Å‡∏ß.7/1", "‡∏Å‡∏ß.7/2", "‡∏™‡∏ß.1/11", "‡∏™‡∏ß.1/12", "‡∏™‡∏ß.1/13", 
  "‡∏™‡∏ß.1/14", "‡∏™‡∏ß.1/15", "‡∏™‡∏ß.1/8B", "‡∏™‡∏ß.1/8C", "‡∏™‡∏ß.1/9A", "‡∏™‡∏ß.1/9B", "‡∏™‡∏ß.1/9C"
];

function showWardList() {
  const dropdown = document.getElementById('wardDropdown');
  dropdown.classList.remove('hidden');
  renderWardOptions(wardList);
}

function filterWardList() {
  const searchTerm = document.getElementById('wardInput').value.toLowerCase();
  const filtered = wardList.filter(ward => ward.toLowerCase().includes(searchTerm));
  renderWardOptions(filtered);
}

function renderWardOptions(list) {
  const container = document.getElementById('wardOptions');
  if (list.length === 0) {
    container.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }
  
  container.innerHTML = list.map(ward => `
    <div onclick="selectWard('${ward}')" 
      class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-gray-700 text-sm transition-colors border-b border-gray-50 last:border-0">
      ${ward}
    </div>
  `).join('');
}

function selectWard(val) {
  document.getElementById('wardInput').value = val;
  document.getElementById('ward').value = val;
  document.getElementById('wardDropdown').classList.add('hidden');
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ (Summary) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (typeof calculateAll === "function") calculateAll();
}

// ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
document.addEventListener('click', function(e) {
  const wardContainer = document.getElementById('wardInput').parentElement;
  if (!wardContainer.contains(e.target)) {
    document.getElementById('wardDropdown').classList.add('hidden');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô List ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å List)
    const currentInput = document.getElementById('wardInput').value;
    if (!wardList.includes(currentInput)) {
      document.getElementById('wardInput').value = '';
      document.getElementById('ward').value = '';
    }
  }
});
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
async function fetchPatientName() {
    const hnInput = document.getElementById('hn');
    const nameInput = document.getElementById('patientName');
    const statusText = document.getElementById('searchStatus');
    const hnValue = hnInput.value.trim().toLowerCase();
    
    // --- ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö HN ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ ---
    if (hnValue === "") {
        nameInput.value = "";
        statusText.innerText = "";
        nameInput.classList.remove('border-blue-500', 'bg-blue-50');
        return;
    }

    if (hnValue.length >= 3) {
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading
        statusText.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°...";
        statusText.className = "text-[11px] mt-1 font-medium text-blue-600 animate-pulse";
        
        try {
            const response = await fetch(`${API_URL}?action=getPatientName&hn=${hnValue}`);
            const result = await response.json();
            
            if (result.patient_name) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡πÄ‡∏à‡∏≠
                nameInput.value = result.patient_name;
                statusText.innerText = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß";
                statusText.className = "text-[11px] mt-1 font-medium text-green-600";
                nameInput.classList.add('border-blue-500', 'bg-blue-50');
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
                statusText.innerText = "‚ùì ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ";
                statusText.className = "text-[11px] mt-1 font-medium text-amber-600";
                nameInput.classList.remove('border-blue-500', 'bg-blue-50');
                // ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà
            }
        } catch (error) {
            statusText.innerText = "‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á";
            statusText.className = "text-[11px] mt-1 font-medium text-red-600";
        }
    }
}

// ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 'input' ‡πÅ‡∏ó‡∏ô 'blur' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (‡∏ñ‡πâ‡∏≤‡∏ä‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô blur ‡∏Ñ‡πà‡∏∞)
document.getElementById('hn').addEventListener('input', fetchPatientName);
    
    // ========== API Functions ==========

async function saveOrder() {
    const orderDate = document.getElementById('orderDate').value;
    const hn = document.getElementById('hn').value;
    const patientName = document.getElementById('patientName').value;
    
    if (!orderDate || !hn || !patientName) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡πà‡∏∞");
        return;
    }

    const saveBtn = document.getElementById('saveOrderBtn');
    saveBtn.disabled = true;
    saveBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏ô‡∏¥‡πâ‡∏ß"
    const data = {
        order_date: orderDate,
        hn: hn,
        patient_name: patientName,
        ward: document.getElementById('ward').value,
        route: document.querySelector('input[name="route"]:checked').value,
        bw: document.getElementById('bw').value,
        
        // Requirements
        total_volume: document.getElementById('totalVolume').value,
        protein_target: document.getElementById('proteinTarget').value,
        fat_target: document.getElementById('fatTarget').value,
        dextrose_percent: document.getElementById('dextrosePercent').value,
        phosphorus: document.getElementById('phosphorus').value,
        sodium: document.getElementById('sodium').value,
        potassium: document.getElementById('potassium').value,
        magnesium: document.getElementById('magnesium').value,
        calcium: document.getElementById('calcium').value,
        
        // Products
        protein_product: document.querySelector('input[name="proteinProduct"]:checked').value,
        fat_product: document.querySelector('input[name="fatProduct"]:checked').value,
        vit_product: document.querySelector('input[name="vitProduct"]:checked').value,

        // Volumes (Net)
        pn_volume: document.getElementById('pnVolume').value,
        protein_vol: document.getElementById('proteinVolInput').value,
        dex_vol: document.getElementById('dextroseVolInput').value,
        phos_vol: document.getElementById('phosvol').value || 0,
        na_vol: document.getElementById('navol').value,
        k_vol: document.getElementById('kvol').value,
        mg_vol: document.getElementById('mgvol').value,
        ca_vol: document.getElementById('cavol').value,
        soluvit_vol: document.getElementById('soluvit').value,
        peditrace_vol: document.getElementById('peditrace').value,
        vitalipid_vol: document.getElementById('vitalipid').value,
        zinc_vol: document.getElementById('zincVolume').value || 0,
        heparin_vol: document.getElementById('row-heparin-vol').innerText,
        additive_other_name: document.getElementById('additiveOtherName').value,
        additive_other_volume: document.getElementById('additiveOtherVolume').value,
        water_net: document.getElementById('waterVolInput').value,

        // Prep Volumes
        pn_prep_total: document.getElementById('pnPrepVolume').value,
        prep_protein_vol: document.getElementById('prep-proteinVol').innerText,
        prep_dex_50_vol: document.getElementById('prep-dextroseVol').innerText,
        prep_phos_vol: document.getElementById('prep-phos-vol').innerText,
        prep_na_vol: document.getElementById('prep-na-vol').innerText,
        prep_k_vol: document.getElementById('prep-k-vol').innerText,
        prep_mg_vol: document.getElementById('prep-mg-vol').innerText,
        prep_ca_vol: document.getElementById('prep-ca-vol').innerText,
        prep_water_vol: document.getElementById('prep-waterVolInput').value,

        // Fat Admin
        flush_option: document.querySelector('input[name="flush"]:checked').value,
        flush_volume: document.getElementById('flushVolume').value || 0,
        total_fat_vit_flush: document.getElementById('totalFatPlusVitalipid').value,
        prep_split: document.querySelector('input[name="prepSplit"]:checked').value,
        fat_rate: document.getElementById('manualFatDripRate').value,
        
        // Summary
        rate_tpn: document.getElementById('rateTPN').value,
        gir_result: document.getElementById('girValue').innerText,
        total_calories: document.getElementById('totalCalDisplay').innerText,
        cal_per_kg: document.getElementById('calPerKg').innerText,
        final_osmolarity: document.getElementById('finalOsmol').innerText.replace('~','').trim(),
        na_from_p_meq: document.getElementById('phoNa').value,
        heparin_units: document.getElementById('heparinUnits').innerText
    };

    try {
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: new URLSearchParams(data)
        });
        alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏ô‡∏¥‡πâ‡∏ß" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!');
    } catch (error) {
        alert('‚ùå ‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏õ‡∏ô‡∏¥‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏°');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order";
    }
}
    function showSaveMessage(message, type) {
      let existingMsg = document.getElementById('saveMessage');
      if (existingMsg) existingMsg.remove();

      const msgDiv = document.createElement('div');
      msgDiv.id = 'saveMessage';
      msgDiv.className = type === 'success' 
        ? 'fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in'
        : 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);

      setTimeout(() => msgDiv.remove(), type === 'success' ? 3000 : 5000);
    }

    // ========== Helper Functions ==========

    function roundToPlace(num, places) {
      const factor = Math.pow(10, places);
      return Math.round((num || 0) * factor) / factor;
    }

    // ========== Calculation Functions ==========

function calculateAll() {
    const bw = parseFloat(document.getElementById('bw').value) || 0;
    const totalVolume = parseFloat(document.getElementById('totalVolume').value) || 0;
    const fatTarget = parseFloat(document.getElementById('fatTarget').value) || 0;
    const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
    const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
    
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Vitalipid Volume
    const vitalipidInput = document.getElementById('vitalipid');
    const vitalipidWarning = document.getElementById('vitalipidMaxWarning');
    const vitalipidFatValue = parseFloat(document.getElementById('vitalipidFatValue').value) || 0;

    if (!isVitalipidManual) {
        let autoVitalipid = bw * 4;
        if (autoVitalipid > 10) autoVitalipid = 10;
        vitalipidInput.value = roundToPlace(autoVitalipid, 1);
    }
    if (vitalipidWarning) {
        vitalipidWarning.classList.toggle('hidden', !(parseFloat(vitalipidInput.value) > 10));
    }
    const vitalipidVolume = parseFloat(vitalipidInput.value) || 0;

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Net Fat
    let netFat = fatTarget;
    if (document.getElementById('deductVitalipid').checked) {
        netFat = Math.max(0, fatTarget - vitalipidFatValue);
    }
    document.getElementById('netFat').value = roundToPlace(netFat, 1);
    document.getElementById('fatDisplay').value = roundToPlace(netFat, 1);

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Fat Volume
    const fatVolInput = document.getElementById('fatVolume');
    const fatVolume = parseFloat(fatVolInput.value) || 0;
    
    // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PN Volume
    const pnVolume = Math.max(0, totalVolume - fatVolume - vitalipidVolume);
    document.getElementById('pnVolume').value = roundToPlace(pnVolume, 1);
    
    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏° Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PN Flush ‡∏ï‡∏≤‡∏° Ward ---
    const pnFlushInput = document.getElementById('pnFlushVolume');
    const currentWard = document.getElementById('ward').value;

    if (!isPNFlushManual) {
        if (["NICU", "2‡∏Ñ"].includes(currentWard)) {
            pnFlushInput.value = ""; // ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà Default
        } else {
            // ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á PICU, PICU ‡∏®‡∏™‡∏Å. ‡πÅ‡∏•‡∏∞ Ward ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 30
            pnFlushInput.value = 30; 
        }
    }
    // --- ‡∏à‡∏ö Logic PN Flush ---

    const pnFlush = parseFloat(pnFlushInput.value) || 0;
    const pnPrepVol = roundToPlace(pnVolume + pnFlush, 1);
    document.getElementById('pnPrepVolume').value = pnPrepVol;

    // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Rate TPN & GIR
    const rateInput = document.getElementById('rateTPN');
    if (!isRateManual) {
        rateInput.value = roundToPlace(pnVolume / 24, 1);
    }
    const finalRate = parseFloat(rateInput.value) || 0;
    const gir = bw > 0 ? (finalRate * dextrosePercent) / (bw * 6) : 0;
    document.getElementById('girValue').textContent = roundToPlace(gir, 2);
    if(document.getElementById('girWarning')) document.getElementById('girWarning').classList.toggle('hidden', !(gir > 12));

    // 6. Electrolytes Logic
    const phosphorus = parseFloat(document.getElementById('phosphorus').value) || 0;
    const sodium = parseFloat(document.getElementById('sodium').value) || 0;
    const potassium = parseFloat(document.getElementById('potassium').value) || 0;
    const magnesium = parseFloat(document.getElementById('magnesium').value) || 0;
    const calcium = parseFloat(document.getElementById('calcium').value) || 0;

    const phosSourceEl = document.querySelector('input[name="phosSource"]:checked');
    const phosSource = phosSourceEl ? phosSourceEl.value : 'Glycophos';

    const phosInput = document.getElementById('phosvol');
    if (!isPhosVolManual) {
        phosInput.value = (phosSource === 'K2HPO4') ? roundToPlace((phosphorus * bw) * 2, 1) : roundToPlace(phosphorus * bw, 1);
    }
    const phosVolume = parseFloat(phosInput.value) || 0;
    
    let phosNa = 0; let kFromPhos = 0;
    if (phosSource === 'Glycophos') {
        if(document.getElementById('naFromP_Row')) document.getElementById('naFromP_Row').classList.remove('hidden');
        if(document.getElementById('kFromP_Row')) document.getElementById('kFromP_Row').classList.add('hidden');
        const phoNaInput = document.getElementById('phoNa');
        if (!isPhosNaManual) { phoNaInput.value = roundToPlace(2 * phosVolume, 1); }
        phosNa = parseFloat(phoNaInput.value) || 0;
        kFromPhos = 0;
    } else {
        if(document.getElementById('naFromP_Row')) document.getElementById('naFromP_Row').classList.add('hidden');
        if(document.getElementById('kFromP_Row')) document.getElementById('kFromP_Row').classList.remove('hidden');
        phosNa = 0;
        kFromPhos = phosVolume; 
        if(document.getElementById('kFromP_Val')) document.getElementById('kFromP_Val').textContent = roundToPlace(kFromPhos, 2);
    }

    const naInput = document.getElementById('navol');
    if (!isNaVolManual) { naInput.value = roundToPlace(Math.max(0, (sodium * bw) - phosNa) / 0.5, 1); }
    const naClVolume = parseFloat(naInput.value) || 0;

    const kInput = document.getElementById('kvol');
    if (!isKVolManual) { 
        let kRemaining = Math.max(0, (potassium * bw) - kFromPhos);
        kInput.value = roundToPlace(kRemaining / 2, 1); 
    }
    const kVolume = parseFloat(kInput.value) || 0;

    const mgInput = document.getElementById('mgvol');
    if (!isMgVolManual) { mgInput.value = roundToPlace((magnesium * bw) / 2, 2); }
    const mgVolume = parseFloat(mgInput.value) || 0;

    const caInput = document.getElementById('cavol');
    const caWarning = document.getElementById('caMaxWarning');
    if (!isCaVolManual) {
        let autoCaVol = calcium * bw;
        if (autoCaVol > 10) { caInput.value = 10; if(caWarning) caWarning.classList.remove('hidden'); }
        else { caInput.value = roundToPlace(autoCaVol, 1); if(caWarning) caWarning.classList.add('hidden'); }
    }
    const caVolume = parseFloat(caInput.value) || 0;

    const electrolytesVolume = phosVolume + naClVolume + kVolume + mgVolume + caVolume;

    // 7. Vitamins & Trace
    const vitInput = document.getElementById('vitvol');
    const vitSource = document.querySelector('input[name="vitSource"]:checked')?.value || 'Soluvit';
    if (!isVitVolManual) {
        vitInput.value = (vitSource === 'Cernevit') ? roundToPlace(Math.min(bw, 5), 1) : roundToPlace(Math.min(bw, 10), 1);
    }
    const vitVolume = parseFloat(vitInput.value) || 0;

    const traceInput = document.getElementById('tracevol');
    const traceSource = document.querySelector('input[name="traceSource"]:checked')?.value || 'Peditrace';
    if (!isTraceVolManual) {
        traceInput.value = (traceSource === 'Addamel') ? roundToPlace(Math.min(bw, 10), 1) : roundToPlace(Math.min(bw, 15), 1);
    }
    const traceVolume = parseFloat(traceInput.value) || 0;

    // --- 8. Additives ---
    let additivesVolume = 0;

    // ‚úÖ ZINC
    let zincVolume = 0;
    const zincSelection = document.querySelector('input[name="zinc"]:checked')?.value;
    const zincInput = document.getElementById('zincvol');
    const zincDiv = document.getElementById('zincVolumeDiv');

    if (zincSelection === 'yes') {
        if (zincDiv) zincDiv.classList.remove('hidden');
        if (document.activeElement !== zincInput && 
            (!zincInput.value || parseFloat(zincInput.value) === 0)) {
            zincInput.value = roundToPlace(0.3 * bw, 2);
        }
        zincVolume = parseFloat(zincInput.value) || 0;
    } else {
        if (zincDiv) zincDiv.classList.add('hidden');
        zincVolume = 0;
        if (zincInput) zincInput.value = '';
    }

    // ‚úÖ HEPARIN
    let heparinVolume = 0;
    const heparinSelection = document.querySelector('input[name="heparin"]:checked')?.value;
    const hepDiv = document.getElementById('heparinValueDiv');

    if (heparinSelection === 'yes') {
        const hepUnits = roundToPlace(1 * pnVolume, 0);
        heparinVolume = roundToPlace(hepUnits / 500, 2);

        const hepUnitsEl = document.getElementById('heparinUnits');
        const hepVolEl = document.getElementById('heparinVolume');

        if (hepUnitsEl) hepUnitsEl.textContent = hepUnits + " units";
        if (hepVolEl)   hepVolEl.textContent   = heparinVolume.toFixed(2) + " ml";
        if (hepDiv)     hepDiv.classList.remove('hidden');
    } else {
        if (hepDiv) hepDiv.classList.add('hidden');
        heparinVolume = 0;
    }

    const otherVol = parseFloat(document.getElementById('additiveOtherVolume').value) || 0;
    additivesVolume = zincVolume + heparinVolume + otherVol;

    // ‚úÖ TABLE SYNC
    const zincVolCell   = document.getElementById('row-zinc-vol');
    const prepZincCell  = document.getElementById('prep-zinc-vol');
    const hepVolCell    = document.getElementById('row-heparin-vol');
    const prepHepCell   = document.getElementById('prep-heparin-vol');

    if (zincVolCell)  zincVolCell.textContent  = roundToPlace(zincVolume, 2);
    if (prepZincCell) prepZincCell.textContent = roundToPlace(zincVolume, 2);
    if (hepVolCell)   hepVolCell.textContent   = roundToPlace(heparinVolume, 2);
    if (prepHepCell)  prepHepCell.textContent  = roundToPlace(heparinVolume, 2);

    // 9. Protein & Dextrose
    const proteinVolume = parseFloat(document.getElementById('proteinVolInput').value) || 0;
    const dextroseVolume = parseFloat(document.getElementById('dextroseVolInput').value) || 0;

    // 10. Water & Totals
    const allSubstances = proteinVolume + dextroseVolume + electrolytesVolume + vitVolume + traceVolume + zincVolume + otherVol + heparinVolume;
    if (!isWaterManual) { document.getElementById('waterVolInput').value = roundToPlace(pnVolume - allSubstances, 1); }
    
    // 11. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    const selectedProt = document.querySelector('input[name="proteinProduct"]:checked');
    if (selectedProt) {
        const protLabel = document.querySelector(`label[for="${selectedProt.id}"]`).textContent;
        document.getElementById('row-protein-name').textContent = protLabel;
    }
    document.getElementById('row-phos-name').textContent = (phosSource === 'Glycophos') ? "- Glycophos (P)" : "- K2HPO4 (P)";
    document.getElementById('row-soluvit-name').textContent = (vitSource === 'Soluvit') ? "- Soluvit N" : "- Cernevit";
    document.getElementById('row-peditrace-name').textContent = (traceSource === 'Peditrace') ? "- Peditrace" : "- Addamel-N";
    
    const otherNameInput = document.getElementById('additiveOtherName').value;
    document.getElementById('row-other-name').textContent = otherNameInput ? "- " + otherNameInput : "- Other Additive";

    // --- ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Volume ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    document.getElementById('proteinVol').textContent = roundToPlace(proteinVolume, 1);
    document.getElementById('dextroseVol').textContent = roundToPlace(dextroseVolume, 1);
    document.getElementById('row-phos-vol').textContent = phosVolume;
    document.getElementById('row-na-vol').textContent = naClVolume;
    document.getElementById('row-k-vol').textContent = kVolume;
    document.getElementById('row-mg-vol').textContent = mgVolume;
    document.getElementById('row-ca-vol').textContent = caVolume;
    document.getElementById('row-soluvit-vol').textContent = vitVolume;
    document.getElementById('row-peditrace-vol').textContent = traceVolume;
    document.getElementById('row-zinc-vol').textContent = zincVolume; 
    document.getElementById('row-heparin-vol').textContent = heparinVolume;
    document.getElementById('row-other-vol').textContent = otherVol;

    // --- ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° ---
    const prepDextroseVol = roundToPlace((dextrosePercent * pnPrepVol * 2) / 100, 1); 
    
    document.getElementById('prep-proteinVol').textContent = roundToPlace(proteinVolume, 1);
    document.getElementById('prep-dextroseVol').textContent = prepDextroseVol;
    document.getElementById('prep-phos-vol').textContent = phosVolume;
    document.getElementById('prep-na-vol').textContent = naClVolume;
    document.getElementById('prep-k-vol').textContent = kVolume;
    document.getElementById('prep-mg-vol').textContent = mgVolume;
    document.getElementById('prep-ca-vol').textContent = caVolume;
    document.getElementById('prep-soluvit-vol').textContent = vitVolume;
    document.getElementById('prep-peditrace-vol').textContent = traceVolume;
    document.getElementById('prep-zinc-vol').textContent = zincVolume;
    document.getElementById('prep-heparin-vol').textContent = heparinVolume;
    document.getElementById('prep-other-vol').textContent = otherVol;

    const allSubstancesPrep = proteinVolume + prepDextroseVol + electrolytesVolume + vitVolume + traceVolume + zincVolume + otherVol + heparinVolume;
    if (!isPrepWaterManual) { 
        document.getElementById('prep-waterVolInput').value = roundToPlace(pnPrepVol - allSubstancesPrep, 1); 
    }

    // 12. Osmolarity Calculation
    const prepVol = pnPrepVol || 1;
    const selectedProtProductOsmol = document.querySelector('input[name="proteinProduct"]:checked').value;
    const protConcOsmol = (selectedProtProductOsmol === 'aminoplasmal') ? 0.15 : 0.10;
    const aaGrams = (parseFloat(document.getElementById('proteinVolInput').value) || 0) * protConcOsmol;
    const osmol_AA = (aaGrams * 10 * 1000) / prepVol;
    const osmol_Dex = (prepDextroseVol * 2.5 * 1000) / prepVol;
    const osmol_Na = (naClVolume * 1000) / prepVol;
    const osmol_K = (kVolume * 4000) / prepVol;
    const osmol_Ca = (caVolume * 430) / prepVol;
    const osmol_Mg = (mgVolume * 4000) / prepVol;
    const osmol_Phos = (phosSource === 'Glycophos') ? (phosVolume * 1000) / prepVol : (phosVolume * 1500) / prepVol;

    document.getElementById('proteinOsmol').textContent   = Math.round(osmol_AA);
    document.getElementById('dextroseOsmol').textContent  = Math.round(osmol_Dex);
    document.getElementById('row-na-osmol').textContent   = Math.round(osmol_Na);
    document.getElementById('row-k-osmol').textContent    = Math.round(osmol_K);
    document.getElementById('row-mg-osmol').textContent   = Math.round(osmol_Mg);
    document.getElementById('row-ca-osmol').textContent   = Math.round(osmol_Ca);
    document.getElementById('row-phos-osmol').textContent = Math.round(osmol_Phos);

    const totalOsmolValue = osmol_AA + osmol_Dex + osmol_Na + osmol_K + osmol_Mg + osmol_Ca + osmol_Phos;
    document.getElementById('totalOsmol').textContent = '~' + Math.round(totalOsmolValue);
    document.getElementById('finalOsmol').textContent = '~' + Math.round(totalOsmolValue);

    const currentRoute = document.querySelector('input[name="route"]:checked').value;
    const osmolWarnEl = document.getElementById('osmolWarning');
    if (osmolWarnEl) {
        osmolWarnEl.classList.toggle('hidden', !(currentRoute === 'peripheral' && totalOsmolValue > 900));
    }

    // 13. Calories & Summaries
    const pCal = proteinVolume * 0.4; 
    const dCal = dextroseVolume * 0.5 * 3.4;
    const fCal = (parseFloat(document.getElementById('fatVolume').value) || 0) * 2;
    
    document.getElementById('proteinCal').textContent = roundToPlace(pCal, 1);
    document.getElementById('dextroseCal').textContent = roundToPlace(dCal, 1);
    document.getElementById('totalPNCal').textContent = roundToPlace(pCal + dCal, 1);
    document.getElementById('totalCalDisplay').textContent = roundToPlace(pCal + dCal + fCal, 1);
    document.getElementById('calPerKg').textContent = bw > 0 ? roundToPlace((pCal + dCal + fCal) / bw, 1) : '0.0';
    
    document.getElementById('totalPNVol_Summary').textContent = roundToPlace(pnVolume, 1);
    document.getElementById('totalPrepVolDisplay').textContent = roundToPlace(pnPrepVol, 1);

    calculateFatAdmin();
    updateOrderSummary();
}
    function calculateFatAdmin() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Volume ‡∏ï‡πà‡∏≤‡∏á‡πÜ
    const fatVolume = parseFloat(document.getElementById('fatVolume').value) || 0;
    const vitalipidVolume = parseFloat(document.getElementById('vitalipid').value) || 0;
    const currentWard = document.getElementById('ward').value; 
    const sumFatVit = fatVolume + vitalipidVolume;
    
    const flushRadioCustom = document.querySelector('input[name="flush"][value="custom"]');
    const flushRadioNone = document.querySelector('input[name="flush"][value="none"]');
    const flushInput = document.getElementById('flushVolume');

    const recommendedRate = roundToPlace((fatVolume + vitalipidVolume) / 22, 1);
    const rateLabel = document.getElementById('autoFatRateLabel');
    if (rateLabel) {
        rateLabel.textContent = `(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ = ${recommendedRate} ml/hr)`;
    }

    // 2. Logic ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ward
    if (!isFlushManual) {
        if (["NICU", "2‡∏Ñ"].includes(currentWard)) {
            flushRadioNone.checked = true;
            flushInput.value = "";
            flushInput.classList.remove('bg-amber-50', 'border-amber-300', 'bg-blue-50', 'border-blue-400');
        } else if (["2‡∏á", "3‡∏á", "IMC2‡∏á"].includes(currentWard)) {
            flushRadioCustom.checked = true;
            flushInput.value = (sumFatVit <= 39) ? 6 : 30;
            flushInput.classList.remove('bg-blue-50', 'border-blue-400');
            flushInput.classList.add('bg-amber-50', 'border-amber-300');
        } else if (["PICU", "PICU ‡∏®‡∏™‡∏Å."].includes(currentWard)) {
            flushRadioCustom.checked = true;
            flushInput.value = (sumFatVit <= 55) ? 3 : 15;
            flushInput.classList.remove('bg-blue-50', 'border-blue-400');
            flushInput.classList.add('bg-amber-50', 'border-amber-300');
        }
    } else {
        flushInput.classList.remove('bg-amber-50', 'border-amber-300');
        flushInput.classList.add('bg-blue-50', 'border-blue-400');
    }

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°
    const flushOption = document.querySelector('input[name="flush"]:checked').value;
    const flushVolume = flushOption === 'custom' ? (parseFloat(flushInput.value) || 0) : 0;
    const prepSplit = document.querySelector('input[name="prepSplit"]:checked').value;
    const manualRate = document.getElementById('manualFatDripRate').value || '0.0';
    
    const selectedFat = document.querySelector('input[name="fatProduct"]:checked');
    const fatName = selectedFat ? document.querySelector(`label[for="${selectedFat.id}"]`).textContent : "Fat";
    
    const totalVolPlusFlush = fatVolume + flushVolume;
    const grandTotalFatVit = totalVolPlusFlush + vitalipidVolume;
    const fatCalories = fatVolume * 2; 

    document.getElementById('totalFatPlusVitalipid').value = roundToPlace(grandTotalFatVit, 1);

    // 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const vitProdType = document.querySelector('input[name="vitProduct"]:checked').value;
    const vitNameLabel = "Vitalipid-N " + vitProdType;

    let prepText = `
        <p>‚Ä¢ <strong>${fatName}</strong>: ${roundToPlace(fatVolume, 1)} ml + ‡∏£‡∏ß‡∏°‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢ (${roundToPlace(flushVolume, 0)} ml): <strong>${roundToPlace(totalVolPlusFlush, 1)}</strong> ml</p>
        <p>‚Ä¢ ${vitNameLabel}: <strong>${roundToPlace(vitalipidVolume, 1)}</strong> ml</p>
        <p class="text-lg">
            ‚Ä¢ Total Volume Fat + ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢ + Vitalipid: 
            <span class="text-2xl font-black text-blue-800 underline ml-1">${roundToPlace(grandTotalFatVit, 1)}</span> 
            <span class="text-blue-800 font-bold ml-1">ml</span>
        </p>
        <p>‚Ä¢ <strong>Calories from fat:</strong> <span class="text-amber-700 font-bold">${roundToPlace(fatCalories, 1)}</span> kcal</p>
    `;

    if (prepSplit === 'split') {
        prepText += `<p>‚Ä¢ <strong>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</strong> <span class="text-blue-700 font-bold">${roundToPlace(grandTotalFatVit / 2, 1)} ml √ó 2 syringe/‡∏Ç‡∏ß‡∏î</span></p>`;
    } else {
        prepText += `<p>‚Ä¢ <strong>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</strong> ‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á</p>`;
    }
    
    prepText += `<p>‚Ä¢ <strong>Drip Rate:</strong> <span class="text-blue-700 font-bold text-lg">${manualRate}</span> ml/hr</p>`;
    
    document.getElementById('prepDetails').innerHTML = prepText;
    updateOrderSummary();
}
    function updateOrderSummary() {
      const orderDate = document.getElementById('orderDate').value;
      const hn = document.getElementById('hn').value || '-';
      const patientName = document.getElementById('patientName').value || '-';
      const ward = document.getElementById('ward').value || '-';
      const route = document.querySelector('input[name="route"]:checked').value;
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const pnVolume = parseFloat(document.getElementById('pnVolume').value) || 0;
      const rateTPN = parseFloat(document.getElementById('rateTPN').value) || 0;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const netFat = parseFloat(document.getElementById('netFat').value) || 0;
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      const gir = parseFloat(document.getElementById('girValue').textContent) || 0;
      const vitalipid = parseFloat(document.getElementById('vitalipid').value) || 0;
      
      // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Vitalipid ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Infant/Adult)
      const vitType = document.querySelector('input[name="vitProduct"]:checked').value;
      
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked');
      const fatProduct = document.querySelector('input[name="fatProduct"]:checked');
      const totalCal = parseFloat(document.getElementById('totalCalDisplay').textContent) || 0;
      const calPerKg = parseFloat(document.getElementById('calPerKg').textContent) || 0;
      
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏à‡∏≤‡∏Å Label
      const proteinProductName = document.querySelector(`label[for="${proteinProduct.id}"]`).textContent;
      const fatProductName = document.querySelector(`label[for="${fatProduct.id}"]`).textContent;
      
      const formattedDate = orderDate ? new Date(orderDate).toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '-';
      
      const summaryHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <p><span class="text-blue-200">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${formattedDate}</p>
            <p><span class="text-blue-200">üè• HN:</span> ${hn}</p>
            <p><span class="text-blue-200">üë§ ‡∏ä‡∏∑‡πà‡∏≠:</span> ${patientName}</p>
            <p><span class="text-blue-200">üõèÔ∏è Ward:</span> ${ward}</p>
            <p><span class="text-blue-200">üíâ Route:</span> ${route === 'central' ? 'Central Line' : 'Peripheral Line'}</p>
          </div>
          <div class="space-y-2">
            <p><span class="text-blue-200">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</span> ${bw} kg</p>
            <p><span class="text-blue-200">üíß PN Volume:</span> ${roundToPlace(pnVolume, 1)} ml</p>
            <p><span class="text-blue-200">‚è±Ô∏è Rate:</span> ${roundToPlace(rateTPN, 1)} ml/hr</p>
            <p><span class="text-blue-200">üî• Total Cal:</span> ${roundToPlace(totalCal, 1)} kcal (${roundToPlace(calPerKg, 1)} kcal/kg/day)</p>
          </div>
        </div>
        <hr class="border-blue-400/30 my-3">
        <div class="space-y-2">
          <p><span class="text-blue-200">ü•© Protein:</span> ${proteinTarget} g/kg/day (${proteinProductName})</p>
          <p><span class="text-blue-200">üßà Fat:</span> ${roundToPlace(netFat, 1)} g/kg/day (${fatProductName})</p>
          <p><span class="text-blue-200">üç¨ Dextrose:</span> ${dextrosePercent}%</p>
          <p><span class="text-blue-200">üìä GIR:</span> ${roundToPlace(gir, 2)} mg/kg/min</p>
          <p><span class="text-blue-200">üíä Vitalipid-N ${vitType}:</span> ${roundToPlace(vitalipid, 1)} ml</p>
        </div>
      `;
      
      document.getElementById('orderSummary').innerHTML = summaryHTML;
    }

function resetForm() {
    // 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Manual Flags ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô false
    isPhosNaManual = false;
    isNaVolManual = false;
    isKVolManual = false;
    isMgVolManual = false;
    isCaVolManual = false;
    isRateManual = false;
    isVitalipidManual = false;
    isSoluvitManual = false;
    isPeditraceManual = false;
    isFlushManual = false;
    isPhosVolManual = false;
    isWaterManual = false;
    isPrepWaterManual = false;

    // 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    document.getElementById('orderDate').valueAsDate = new Date();
    document.getElementById('hn').value = '';
    document.getElementById('patientName').value = '';
    document.getElementById('wardInput').value = '';
    document.getElementById('ward').value = '';

    // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Input (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô calculateAll)
    const inputsToClear = [
        'bw', 'totalVolume', 'fatTarget', 'proteinTarget', 'proteinGrams', 'proteinVolInput',
        'dextrosePercent', 'dextroseGrams', 'dextroseVolInput',
        'phosphorus', 'phosvol', 'phoNa', 'sodium', 'navol', 'potassium', 'kvol',
        'magnesium', 'mgvol', 'calcium', 'cavol',
        'flushVolume', 'vitalipid', 'vitvol', 'tracevol', 'zincvol', // ‡πÉ‡∏ä‡πâ id ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö calculateAll
        'manualFatDripRate', 'additiveOtherName', 'additiveOtherVolume', 'rateTPN',
        'fatVolume', 'netFat', 'waterVolInput', 'prep-waterVolInput'
    ];

    inputsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = '';
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà 0.0 ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            if (id === 'waterVolInput' || id === 'prep-waterVolInput') el.value = '0.0';
        }
    });

    // 4. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©
    document.getElementById('pnFlushVolume').value = 30;
    document.getElementById('vitalipidFatValue').value = 0.4;
    document.getElementById('deductVitalipid').checked = false;
    document.getElementById('isPreterm').checked = false;
    document.getElementById('totalFatPlusVitalipid').value = '0.0'; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ Fat+Vit

    // 5. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Radio Buttons)
    document.querySelector('input[name="route"][value="central"]').checked = true;
    document.querySelector('input[name="proteinProduct"][value="aminoven"]').checked = true;
    document.querySelector('input[name="fatProduct"][value="smof"]').checked = true;
    if (document.getElementById('vitInfant')) document.getElementById('vitInfant').checked = true;
    document.querySelector('input[name="flush"][value="none"]').checked = true;
    document.querySelector('input[name="prepSplit"][value="none"]').checked = true;
    document.querySelector('input[name="heparin"][value="no"]').checked = true;
    document.querySelector('input[name="zinc"][value="no"]').checked = true;

    // 6. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ (Composition Table) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0.0
    const tableCells = [
        'proteinVol', 'prep-proteinVol', 'proteinCal', 'proteinOsmol',
        'dextroseVol', 'prep-dextroseVol', 'dextroseCal', 'dextroseOsmol',
        'row-phos-vol', 'prep-phos-vol', 'row-phos-osmol',
        'row-na-vol', 'prep-na-vol', 'row-na-osmol',
        'row-k-vol', 'prep-k-vol', 'row-k-osmol',
        'row-mg-vol', 'prep-mg-vol', 'row-mg-osmol',
        'row-ca-vol', 'prep-ca-vol', 'row-ca-osmol',
        'row-soluvit-vol', 'prep-soluvit-vol',
        'row-peditrace-vol', 'prep-peditrace-vol',
        'row-zinc-vol', 'prep-zinc-vol',
        'row-heparin-vol', 'prep-heparin-vol',
        'row-other-vol', 'prep-other-vol',
        'totalPNVol', 'totalPrepVolDisplay', 'totalPNCal', 'totalOsmol',
        'totalPNVol_Summary' // ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    ];
    tableCells.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0.0';
    });

    // 7. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    document.getElementById('totalCalDisplay').textContent = '0.0';
    document.getElementById('calPerKg').textContent = '0.0';
    document.getElementById('finalOsmol').textContent = '0';
    document.getElementById('girValue').textContent = '0.00';
    document.getElementById('heparinUnits').textContent = '0';
    document.getElementById('heparinVolume').textContent = '0.00';
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå HTML ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const prepDetails = document.getElementById('prepDetails');
    if (prepDetails) prepDetails.innerHTML = ''; 

    // 8. ‡∏ã‡πà‡∏≠‡∏ô Warning ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const elementsToHide = [
        'girWarning', 'osmolWarning', 'caMaxWarning', 'vitalipidMaxWarning',
        'soluvitWarning', 'peditraceWarning', 'waterLimitWarning',
        'zincOptions', 'zincVolumeDiv', 'heparinValueDiv', 'searchStatus'
    ];
    elementsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });

    document.getElementById('searchStatus').innerText = '';

    // 9. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏µ Input ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    const flushInput = document.getElementById('flushVolume');
    if (flushInput) {
        flushInput.classList.remove('bg-amber-50', 'border-amber-300', 'bg-blue-50', 'border-blue-400');
        flushInput.classList.add('bg-blue-50', 'border-blue-200');
    }

    // 10. ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 0
    calculateAll();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    console.log("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
}
    // ========== Event Listeners ==========

    document.querySelectorAll('input[name="route"]').forEach(radio => {
      radio.addEventListener('change', calculateAll);
    });

    // ========== Initialize ==========

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ TPN Calculator ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      console.log('üì° ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö:', API_URL);
      document.getElementById('orderDate').valueAsDate = new Date();
      calculateAll();
    });
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ Vitalipid ‡πÄ‡∏≠‡∏á
function handleVitalipidManualChange() {
  isVitalipidManual = true; 
  calculateAll();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ Rate ‡πÄ‡∏≠‡∏á
function handleRateManualChange() {
  isRateManual = true; 
  calculateAll();
}
function calculateFatLogic(source) {
    const bw = parseFloat(document.getElementById('bw').value) || 0;
    const isDeduct = document.getElementById('deductVitalipid').checked;
    const vFatVal = parseFloat(document.getElementById('vitalipidFatValue').value) || 0.4;
    const fConc = 0.20; // 20% Lipid
  const fatNameCell = document.getElementById('row-fat-name'); // ‡∏´‡∏£‡∏∑‡∏≠ id ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ Fat ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
if (fatNameCell) fatNameCell.textContent = "- " + fatName;
    
    let fTarget = parseFloat(document.getElementById('fatTarget').value) || 0;
    let fVol = parseFloat(document.getElementById('fatVolume').value) || 0;
    let netFat = 0;

    if (source === 'fat_dose') {
        netFat = isDeduct ? Math.max(0, fTarget - vFatVal) : fTarget;
        fVol = (netFat * bw) / fConc;
        document.getElementById('fatVolume').value = roundToPlace(fVol, 1);
    } else if (source === 'fat_vol') {
        netFat = (fVol * fConc) / (bw > 0 ? bw : 1);
        fTarget = isDeduct ? netFat + vFatVal : netFat;
        document.getElementById('fatTarget').value = roundToPlace(fTarget, 1);
    }
    
    document.getElementById('netFat').value = roundToPlace(netFat, 1);
    calculateAll(); // ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô calculateAll ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}

function calculateProteinLogic(source) {
    const bw = parseFloat(document.getElementById('bw').value) || 0;
    const selectedProduct = document.querySelector('input[name="proteinProduct"]:checked').value;
    const activeEl = document.activeElement.id; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 10% ‡πÅ‡∏•‡∏∞ 15%)
    let pConc = (selectedProduct === 'aminoplasmal') ? 0.15 : 0.10;
    
    let pDose = parseFloat(document.getElementById('proteinTarget').value) || 0;
    let pGrams = parseFloat(document.getElementById('proteinGrams').value) || 0;
    let pVol = parseFloat(document.getElementById('proteinVolInput').value) || 0;

    if (source === 'prot_dose') {
        pGrams = pDose * bw;
        pVol = pGrams / pConc;
    } else if (source === 'prot_grams') {
        pDose = bw > 0 ? pGrams / bw : 0;
        pVol = pGrams / pConc;
    } else if (source === 'prot_vol') {
        pGrams = pVol * pConc;
        pDose = bw > 0 ? pGrams / bw : 0;
    }

    // üî• ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ: ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà (Active Element)
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á
    if (activeEl !== 'proteinTarget') {
        document.getElementById('proteinTarget').value = roundToPlace(pDose, 1);
    }
    if (activeEl !== 'proteinGrams') {
        document.getElementById('proteinGrams').value = roundToPlace(pGrams, 2);
    }
    if (activeEl !== 'proteinVolInput') {
        document.getElementById('proteinVolInput').value = roundToPlace(pVol, 1);
    }
    
    calculateAll(); 
}
function calculateDextroseLogic(source) {
    const bw = parseFloat(document.getElementById('bw').value) || 0;
    const pnVol = parseFloat(document.getElementById('pnVolume').value) || 0;
    const activeEl = document.activeElement.id; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    
    let dPercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
    let dGrams = parseFloat(document.getElementById('dextroseGrams').value) || 0;
    let dVol50 = parseFloat(document.getElementById('dextroseVolInput').value) || 0;

    if (source === 'dex_percent') {
        dGrams = (dPercent * pnVol) / 100;
        dVol50 = dGrams / 0.5;
    } else if (source === 'dex_grams') {
        dPercent = pnVol > 0 ? (dGrams / pnVol) * 100 : 0;
        dVol50 = dGrams / 0.5;
    } else if (source === 'dex_vol') {
        dGrams = dVol50 * 0.5;
        dPercent = pnVol > 0 ? (dGrams / pnVol) * 100 : 0;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Input "‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà"
    if (activeEl !== 'dextrosePercent') document.getElementById('dextrosePercent').value = roundToPlace(dPercent, 1);
    if (activeEl !== 'dextroseGrams') document.getElementById('dextroseGrams').value = roundToPlace(dGrams, 1);
    if (activeEl !== 'dextroseVolInput') document.getElementById('dextroseVolInput').value = roundToPlace(dVol50, 1);
    
    calculateAll();
}
  function setToday() {
  const dateInput = document.getElementById('orderDate');
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  
  dateInput.value = `${year}-${month}-${day}`;
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Summary ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (typeof calculateAll === "function") calculateAll();
}
document.getElementById('pnFlushVolume').addEventListener('input', () => {
    isPNFlushManual = true; // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¥‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
    calculateAll();
});
  </script>
</body>
</html>
